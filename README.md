# VAT Chain Transaction Solver using LLMs and Knowledge Graphs

This application was developed to solve **Chain Transaction (CT) cases** under **Austrian tax law** using **Large Language Models (LLMs)** and **Knowledge Graphs (KGs)**.

The tool extracts knowledge from natural language text, generates a knowledge graph in **Neo4j Aura**, runs a set of predefined **Cypher queries**, and applies **logic-based rules** to identify the **movable supply** in chain transactions.

---

## üß† Key Technologies

- **Large Language Models (LLMs)** via Langsmith
- **Neo4j Aura** for knowledge graph storage and querying
- **Python** for orchestration and logic rules
- **Cypher** query language for graph processing

---

## üöÄ Getting Started

### 1. Installation

Clone the repository and install the dependencies:

```bash
pip install -r requirements.txt
```

### 2. Setup

- Ensure that your **Neo4j Aura instance is running**.
- Create a `.env` file in the root directory with the correct credentials for:
  - Neo4j Aura
  - Langsmith

### 3. Files Overview

- `run_experiment.py`  
  Connects to the LLM via Langsmith and generates Cypher statements.

- `ct_solver.py`  
  Processes LLM output, builds the knowledge graph, applies logic rules, and identifies the movable supply.

---

## ‚öôÔ∏è Core Functions

### `apply_logic_based_rules(graph, df)`
- Runs queries and applies logic to:
  1. Identify and extract key data.
  2. Check if a valid chain transaction exists.
  3. Determine the movable supply.

### `build_graph(query)`
- Executes Cypher statements to build the KG in Neo4j.

### `clean_statement(statement)`
- Cleans LLM-generated Cypher statements to remove inconsistencies.

### `delete_graph()`
- Deletes the current graph from the Neo4j database.

### `replace_name_fields(text)`
- Normalizes entity names to ensure consistency.

### `visualize_graph(graph, tv_name, id_internal, example_name)`
- Custom visualization of the graph and the identified movable supply.

---


## üìä Data Processing Pipeline

1. Load a `.csv` file generated by the LLM application (Langsmith).
2. Merge with stored case database using IDs.
3. Initialize Neo4j connection and build the graph.
4. Apply logic rules to detect chain transaction patterns.
5. Compare identified movable supply with sample solution:
   - If it matches ‚Üí `correct`
   - If not ‚Üí `check manually` 
6. Visualize the knowledge graph.

---

## üîß Experimental setup
1. Set up a Neo4j Aura Instance.
2. Set up a LLM Platform (we used Langsmith from Langhchain).
3. Access the code repository and follow the installation guide.
4. Use the provided cases for your LLM application ('data\real_world_cases_utf8.csv', 'data\exam_cases_utf8.csv'). These are all cases of the Real-world and the Exam set, regardless of whether they are classified as excluded or not.
5. Reach out to us an we can provide a direct link to the Langsmith datasets.
6. Access the original data sources for censored cases.
7. The output of the LLM must contain a column 'outputs'.

| outputs | 
|----------|
| Structured output in JSON format. It must contain a JSON object "Cypher Anweisungen" (translated: Cypher statements) |

8. Run the script in ct_solver.py.
9. You receive an .xlsx output in the \output folder and a .pdf file containing the visual representation of the graph in the \pdf_graph folder.
10. Open the '{input_filename}_{timestamp}_output_file.xlsx' file and compare columns 'identified_movable_supply' and 'sample_solution_movable_supply' for cases where result is 'Check manually'.
11. Decide if the moveable supply is correct, wrong or the case must be excluded.
12. Make sure to exclude cases according to the evaluation guideline. See the 'results' column of the [experimental results repository](https://github.com/knolukas/ct-solver-results.git). Excluded cased are named as such in this column. Use the interal_id to match the respective cases.
13. Only use correctly represented cases (correct KG) for the application of law-based rules.
14. Calculate accuaracy (Correct/(Total - Excluded)).

## üõ† Exception Handling

All exceptions are logged with the following information:

- Exception type
- File name
- Line number
- Error message

---

## üì¨ Contact

For questions or contributions, please contact:  
üìß knogler.lukas@gmail.com

---

## üìö Related Work

This repository is part of the research project:

**Using Large Language Models and Knowledge Graphs for Deciding VAT Chain-Transaction Cases in Austrian Tax Law**  
*Author: Lukas Knogler, Johannes Kepler University Linz, Altenberger Str. 69, 4040 Linz, Austria*  https://doi.org/10.5281/zenodo.16112381

See the [experimental results repository](https://github.com/knolukas/ct-solver-results.git) for more.
