# Chain Transaction Solver using LLMs and Knowledge Graphs

This application was developed to solve **Chain Transaction (CT) cases** under **Austrian tax law** using **Large Language Models (LLMs)** and **Knowledge Graphs (KGs)**.

The tool extracts knowledge from natural language text, generates a knowledge graph in **Neo4j Aura**, runs a set of predefined **Cypher queries**, and applies **logic-based rules** to identify the **movable supply** in chain transactions.

---

## üß† Key Technologies

- **Large Language Models (LLMs)** via Langsmith
- **Neo4j Aura** for knowledge graph storage and querying
- **Python** for orchestration and logic rules
- **Cypher** query language for graph processing

---

## üöÄ Getting Started

### 1. Installation

Clone the repository and install the dependencies:

```bash
pip install -r requirements.txt
```

### 2. Setup

- Ensure that your **Neo4j Aura instance is running**.
- Create a `.env` file in the root directory with the correct credentials for:
  - Neo4j Aura
  - Langsmith

### 3. Files Overview

- `run_experiment.py`  
  Connects to the LLM via Langsmith and generates Cypher statements.

- `ct_solver.py`  
  Processes LLM output, builds the knowledge graph, applies logic rules, and identifies the movable supply.

---

## ‚öôÔ∏è Core Functions

### `apply_logic_based_rules(graph, df)`
- Runs queries and applies logic to:
  1. Identify and extract key data.
  2. Check if a valid chain transaction exists.
  3. Determine the movable supply.

### `build_graph(query)`
- Executes Cypher statements to build the KG in Neo4j.

### `clean_statement(statement)`
- Cleans LLM-generated Cypher statements to remove inconsistencies.

### `delete_graph()`
- Deletes the current graph from the Neo4j database.

### `replace_name_fields(text)`
- Normalizes entity names to ensure consistency.

### `visualize_graph(graph, tv_name, id_internal, example_name)`
- Custom visualization of the graph and the identified movable supply.

---

## üßæ Key Cypher Queries

```cypher
// Find last enterprise
OPTIONAL MATCH (n:Unternehmen)-[:BESTELLUNG]->()
WHERE NOT n:Transportverantwortung AND NOT EXISTS {
  MATCH ()-[:BESTELLUNG]->(n)
}
RETURN COALESCE(n, "Inconsistent, no solution.") AS result
```

```cypher
// Find first enterprise
OPTIONAL MATCH ()-[:BESTELLUNG]->(n:Unternehmen)
WHERE NOT n:Transportverantwortung AND NOT EXISTS {
  MATCH (n)-[:BESTELLUNG]->()
}
RETURN COALESCE(n, "Inconsistent, no solution.") AS result
```

```cypher
// Find delivery (transport)
OPTIONAL MATCH (n:Unternehmen)-[:WARENBEWEGUNG]->(m:Unternehmen)
RETURN n, 'WARENBEWEGUNG' as Info, m
```

```cypher
// Check if valid CT (chain transaction)
MATCH path = (start:Unternehmen)-[r1:BESTELLUNG*]->(end:Unternehmen)
OPTIONAL MATCH delivery_path = (n)-[r2:WARENBEWEGUNG]->(start)
WHERE size(r1) >= 2
RETURN CASE
  WHEN r2 IS NULL THEN "Kein Reihengesch√§ft: Keine direkte Lieferung vom letzten zum ersten K√§ufer."
  WHEN size(r1) < 2 THEN "Kein Reihengesch√§ft: Nur 2 Unternehmen involviert."
  WHEN NOT ALL(rel IN relationships(path) WHERE rel.Produkt = r2.Produkt)
    THEN "Kein Reihengesch√§ft: Produktabweichung in der Bestellkette."
  ELSE {
    Beteiligte: nodes(path),
    Bestellungen: (path),
    Lieferung: delivery_path,
    Status: "Reihengesch√§ft erkannt!"
  }
END AS Ergebnis
```

(Additional queries for transport responsibility, product counts, departure states, etc., are included in the source code.)

---

## üìä Data Processing Pipeline

1. Load a `.csv` file generated by the LLM application (Langsmith).
2. Merge with stored case database using IDs.
3. Initialize Neo4j connection and build the graph.
4. Apply logic rules to detect chain transaction patterns.
5. Compare identified movable supply with sample solution:
   - If it matches ‚Üí mark as `richtig`.
   - If not ‚Üí mark as `pr√ºfung` (manual check required).
6. Visualize the knowledge graph.

---

## üõ†Ô∏è Exception Handling

All exceptions are logged with the following information:

- Exception type
- File name
- Line number
- Error message

---

## üìÑ License

[Specify license here, e.g., MIT, Apache 2.0, etc.]

---

## üì¨ Contact

For questions or contributions, please contact:  
üìß [Your Email Address]

---

## üìö Related Work

This repository is part of the research project:

**Using Large Language Models and Knowledge Graphs for Deciding VAT Chain-Transaction Cases in Austrian Tax Law**  
*Author: Lukas Knogler, Austria (JKU Linz)*  
See the [experimental results repository](#) for more.
